<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
          name="viewport">
    <title>간단한 지도 표시하기</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"
            type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/mapUtils.js"></script>
    <style>
        .form-control:focus {
            border-color: #dee2e6 !important;  /* 기본 테두리 색상 유지 */
            box-shadow: none !important;
            outline: 0 !important;
        }
    </style>
</head>
<body>
<div class="container-fluid" style="height: 100vh;">
    <div class="row" style="height: 100vh;">
        <div class="col-4">
            <div class="row position-relative" style="height: 100vh;">
                <nav class="col-xl-3 pt-3 d-flex flex-column justify-content-between">
                    <div>
                        <h4 class="text-dark text-center">
                            <a href="/home" class="text-decoration-none text-dark">모두의<br>여행</a>
                        </h4>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/selectDate')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/selectDate">날짜 선택</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/selectLocation')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/selectLocation">일정 선택</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/selectHotel')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/selectHotel">숙소 선택</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/createSchdule')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/createSchdule">일정 확인</a>
                            </li>
                        </ul>
                    </div>
                    <div class="d-flex justify-content-center mb-4">
                        <button class="btn btn-primary btn-sm" id="nextPageBtn" type="button">다음</button>
                    </div>
                </nav>
                <div class="col-xl-9 " style="height: 100vh;">
                    <div class="d-flex justify-content-between align-items-start p-3">
                        <!-- 왼쪽 컨테이너: 텍스트 정보 -->
                        <div class="flex-grow-1">
                            <p class="fs-4 fw-bold mb-1" data-th-text="${trip.city.state.stateName} + ${trip.city.cityName}">제주도</p>
                            <p class="text-secondary mb-1" data-th-text="${trip.startDate} +' ~ '+  ${trip.endDate}">2024-01-01 ~ 2024-02-01</p>
                        </div>

                        <!-- 오른쪽 컨테이너: 버튼 -->
                        <div class="d-flex align-items-start">
                            <button class="btn btn-sm bg-dark text-white ms-2"
                                    data-bs-target="#appendMyLocation"
                                    data-bs-toggle="collapse">접기
                            </button>
                        </div>
                    </div>

                    <div class="container">
                        <div class="row">
                            <div class="col-md-6 d-flex justify-content-center mb-2">
                                <!-- 장소선택 버튼 -->
                                <button class="btn w-100 rounded-0 border border-top-0 border-start-0 border-end-0 border-primary"
                                        id="showLocationListBtn"
                                        type="button">숙소선택
                                </button>
                            </div>

                            <div class="col-md-6 d-flex justify-content-center mb-2">
                                <!-- 장소추가 버튼 -->
                                <button class="btn w-100 rounded-0 border border-top-0 border-start-0 border-end-0"
                                        id="showAddLocationBtn"
                                        type="button">숙소추가
                                </button>
                            </div>
                        </div>
                    </div>


                    <!-- 위치 리스트 영역 -->
                    <div class="my-4" id="locationListDiv" style="width: 100%;">
                        <!-- 검색창 영역 -->
                        <div class="input-group mb-3 shadow-sm focus-ring-0">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text"
                                   class="form-control border-start-0 focus-ring-0"
                                   placeholder="검색어를 입력하세요"
                                   aria-label="Search">
                        </div>
                        <div style="height: calc(100vh - 250px); overflow-y: auto;">
                            <div class="mb-2" data-th-each="location, status : ${hotelList}"
                                 data-th-object="${location}">
                                <div class="card" style="width: 100%; height: 100px;">
                                    <div class="card-body d-flex align-items-center justify-content-between gap-1 ">
                                        <!-- 이미지 영역 -->
                                        <img alt="Location Image" class="rounded me-3"
                                             data-th-src="${location.locationPhoto} ?: '/images/default.jpg'"
                                             style="width: 70px; height: 70px; object-fit: cover;">

                                        <!-- 텍스트 정보 영역 -->
                                        <div class="d-flex flex-column" style="flex: 1;">
                                            <h5 class="card-title mb-1" data-th-text="*{locationName}"
                                                style="font-size: 16px;">
                                                여행지이름</h5>
                                            <p class="card-text text-muted mb-0" data-th-text="*{locationAddr}"
                                               style="font-size: 12px;">
                                                주소</p>
                                        </div>

                                        <!-- 버튼 영역 -->
                                        <button class="btn btn-outline-secondary btn-location d-flex justify-content-center align-items-center"
                                                data-th-attr="data-index=${status.index}"
                                                style="height: 60px; width: 30px;">
                                            <i class="bi bi-plus-lg"></i>
                                            <span class="location-x d-none" data-th-text="*{locationX}"></span>
                                            <span class="location-y d-none" data-th-text="*{locationY}"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-8 collapse show bg-white text-white position-absolute start-100 h-100"
                     id="appendMyLocation" style="z-index: 1; height: 100vh; overflow-y: auto;">
                    <div class="my-4 h-3" data-th-each="i : ${#numbers.sequence(1, trip.totalDay)}">
                        <div class="card-body border rounded d-flex align-items-center justify-content-between gap-2 m-2">
                            <div class="d-flex justify-content-center align-items-center rounded-circle bg-primary text-white m-2"
                                 data-th-text="${i}"
                                 style="width: 20px; height: 20px; font-size: 10px;">1
                            </div>

                            <div class="img-tag" style="width: 50px;">
                                <div class="btn btn-outline-secondary" id="img-container">
                                    <i class="bi bi-plus"></i>
                                </div>
                            </div>

                            <div class="d-flex flex-column mt-2 gap-1" style="flex: 1 1 0%;">
                                <h1 class="card-text text-muted mb-0"
                                    style="font-size: 12px;">날짜 출력</h1>
                                <h5 class="card-title mb-1 text-dark" style="font-size: 16px;">
                                    장소를 추가하세요.</h5>
                            </div>
                            <button class="btn btn-location d-flex justify-content-center align-items-center m-2"
                                    data-index="0" style="height: 50px; width: 30px; display: none">
                                <span class="location-x d-none">null</span>
                                <span class="location-y d-none">null</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="col-8 bg-white text-primary" id="map" style="height: 100vh;"></div>

        <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fad" id="myModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <!-- 모달 헤더 -->
                    <div class="modal-header">
                        <h5 class="modal-title" id="myModalLabel">일정 선택</h5>
                    </div>

                    <!-- 모달 바디 -->
                    <div class="modal-body" id="modalContent">

                    </div>
                    <!-- 모달 푸터 -->
                    <div class="modal-footer">
                        <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">닫기</button>
                        <button class="btn btn-primary" id="saveButton" type="button">저장</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script data-th-inline="javascript">
    const btn = document.getElementById("openModalBtn");
    const startDate = new Date(/*[[${trip.startDate}]]*/ '');
    const endDate = new Date(/*[[${trip.endDate}]]*/ '');
    const totalDay = /*[[${trip.totalDay}]]*/'';
    const locationListDiv = document.getElementById("locationListDiv");
    const appendMyLocation = document.getElementById("appendMyLocation");
    const addBtns = locationListDiv.querySelectorAll(".btn");
    const modal = document.getElementById('myModal');
    const saveButton = document.getElementById('saveButton'); // 저장 버튼 선택
    let imageUrl;
    let title;
    let dataIndex;
    let selectedItems = Array(totalDay).fill(null);
    let preSelectedItems = [...selectedItems];

    document.addEventListener('DOMContentLoaded', () => {
        const stateName = /*[[${trip.city.state.stateName}]]*/ '';
        const cityName = /*[[${trip.city.cityName}]]*/ '';

        // 지도 초기화
        initializeMap('map', stateName, cityName);
    });

    locationListDiv.addEventListener('click', (event) => {
        const button = event.target.closest('.btn-location');
        if (button) {
            const cardBody = button.closest('.card-body');
            imageUrl = cardBody.querySelector('img').getAttribute('src');
            title = cardBody.querySelector('.card-title').textContent;
            dataIndex = button.getAttribute('data-index');
            openModal();
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        // 모달 콘텐츠 요소 선택
        const modalContent = document.getElementById("modalContent");
        // container 요소 생성
        const container = document.createElement("div");
        container.classList.add("container", "border");
        // row 요소 생성
        const row = document.createElement("div");
        row.classList.add("row", "row-cols-5", "justify-content-center", "p-4");
        // 날짜 범위 내에서 각 날짜마다 col 요소 생성
        for (let date = new Date(startDate); date < endDate; date.setDate(date.getDate() + 1)) {
            // col 생성
            const col = document.createElement("div");
            col.classList.add("col", "d-flex", "flex-column", "justify-content-center", "align-items-center", "border", "border-primary", "rounded", "pt-3", "m-1");
            // 날짜 p 요소 생성 및 설정
            const dateP = document.createElement("p");
            dateP.textContent = date.toISOString().split("T")[0]; // "YYYY-MM-DD" 형식으로 표시
            col.appendChild(dateP);
            // 버튼 생성
            const button = document.createElement("button");
            button.classList.add("btn", "btn-outline-secondary", "btn-location", "d-flex", "justify-content-center", "align-items-center");
            // 아이콘 생성 및 버튼에 추가
            const icon = document.createElement("i");
            icon.classList.add("bi", "bi-plus-lg");
            button.appendChild(icon);
            col.appendChild(button);
            // 텍스트 p 요소 생성
            const textP = document.createElement("p");
            textP.classList.add("text-center", "text-wrap", "w-100");
            textP.classList.add("small-text");
            textP.textContent = "";
            col.appendChild(textP);
            // 정보 저장을 위한 숨김 span 요소 생성
            const infoSpan = document.createElement("span");
            infoSpan.classList.add("d-none"); // Bootstrap의 d-none 클래스로 숨김 처리
            infoSpan.textContent = ""; // 저장할 정보 설정
            // 필요한 부모 요소에 추가 (예: col)
            col.appendChild(infoSpan);
            // col을 row에 추가
            row.appendChild(col);
        }

        // row를 container에 추가
        container.appendChild(row);
        // 최종 container를 modalContent에 추가
        modalContent.appendChild(container);
    });

    // 모달 열기 함수
    function openModal() {
        const modalElement = document.getElementById("myModal");
        const myModal = new bootstrap.Modal(modalElement);
        myModal.show();
    }

    // 모달이 열릴 때 이전 선택된 상태 복원
    modal.addEventListener('show.bs.modal', function () {
        const modalRow = document.querySelector('.modal .row');
        preSelectedItems = [...selectedItems]; // 현재 상태를 복사하여 저장
        if (modalRow) {
            modalRow.querySelectorAll('.btn-location').forEach((modalButton, index) => {
                const modalCol = modalButton.closest('.col');
                const textElement = modalCol.querySelector('.text-center');
                const spanElement = modalCol.querySelector('.d-none');

                // `selectedItems`에 포함된 인덱스는 선택된 상태로 복원
                const selectedItem = selectedItems[index];
                if (selectedItem) {
                    modalButton.innerHTML = `<img src="${selectedItem.url}" alt="Selected Image" style="width: 30px; height: 30px; object-fit: cover;">`;
                    textElement.textContent = selectedItem.title;
                    spanElement.textContent = selectedItem.dtIndex;
                } else {
                    modalButton.innerHTML = `<i class="bi bi-plus-lg"></i>`;
                    textElement.textContent = "";
                    spanElement.textContent = "";
                }
            });
        }
    });

    // 모달 내에서 버튼 클릭 시 실시간으로 selectedItems 배열 업데이트
    modal.addEventListener('click', function (event) {
        if (event.target.closest('.btn-location')) {
            const modalButton = event.target.closest('.btn-location');
            const modalCol = modalButton.closest('.col');
            const textElement = modalCol.querySelector('.text-center');
            const spanElement = modalCol.querySelector('.d-none');
            const index = Array.from(modal.querySelectorAll('.btn-location')).indexOf(modalButton);

            if (modalButton.querySelector('img')) {
                // 선택 해제
                modalButton.innerHTML = `<i class="bi bi-plus-lg"></i>`;
                textElement.textContent = "";
                spanElement.textContent = "";

                // selectedItems 배열에서 해당 항목을 null로 설정하여 선택 해제
                selectedItems[index] = null;
            } else {
                // 선택 추가
                modalButton.innerHTML = `<img data-image-url="${imageUrl}" src="${imageUrl}" alt="Selected Image" style="width: 30px; height: 30px; object-fit: cover;">`;
                textElement.textContent = title;
                spanElement.textContent = dataIndex;

                // selectedItems 배열의 해당 인덱스에 title과 url 정보 저장
                selectedItems[index] = {
                    dataIndex: dataIndex,
                    title: title,
                    url: imageUrl
                };
            }
        }
    });

    function initializeButtons(buttons) {
        // 1. 모든 버튼을 초기화
        addBtns.forEach(button => {
            button.classList.remove("btn-primary");
            button.classList.add("btn-outline-secondary");

            const icon = button.querySelector("i");
            if (icon) {
                icon.classList.remove("bi-check-lg");
                icon.classList.add("bi-plus-lg");
            }
        });
    }

    function updateSelectedButtons(dataIndexList) {
        // 2. dataIndexList를 순회하며 해당하는 버튼의 아이콘 업데이트
        dataIndexList.forEach(dataIndex => {
            if (dataIndex !== null) { // null이 아닌 경우만 처리
                // data-index가 해당 dataIndex인 버튼 찾기
                const button = document.querySelector(`.btn-location[data-index="${dataIndex}"]`);
                const icon = button.querySelector("i");

                if (button && icon) {
                    // 선택된 버튼 스타일 업데이트
                    button.classList.remove("btn-outline-secondary");
                    button.classList.add("btn-primary");

                    // 아이콘을 체크 아이콘으로 변경
                    icon.classList.remove("bi-plus-lg");
                    icon.classList.add("bi-check-lg");
                }
            }
        });
    }

    // 저장 버튼 클릭 시 선택된 항목 유지하고 모달 닫기
    saveButton.addEventListener('click', function () {
        const myModal = bootstrap.Modal.getInstance(modal);
        preSelectedItems = [...selectedItems]; // 저장된 상태를 preSelectedItems에 덮어쓰기
        const dataIndexList = selectedItems.map(item => item ? item.dataIndex : null);

        // 버튼 초기화 및 선택된 항목 업데이트
        initializeButtons(addBtns);
        updateSelectedButtons(dataIndexList);
        modifyLocation(dataIndexList);
        myModal.hide(); // 모달 닫기
    });

    // 모달이 닫힐 때 selectedItems를 preSelectedItems로 복구하는 이벤트 추가
    modal.addEventListener('hide.bs.modal', function () {
        selectedItems = [...preSelectedItems]; // 닫기 시 이전 선택 상태로 복구
    });

    function renderLocationCards(data) {

        const container = document.getElementById("appendMyLocation");
        // markerList의 모든 마커를 지도에서 제거
        markerList.forEach(marker => {
            marker.setMap(null);
        });

        // markerList 배열 비우기 (옵션)
        markerList = [];
        data.forEach((location, index) => {
            const locationDiv = container.children[index];
            // img-tag 및 btn-location 선택
            const imgTag = locationDiv.querySelector(".img-tag");
            const locationButton = locationDiv.querySelector(".btn-location");
            const titleText = locationDiv.querySelector(".card-title");
            const spanX = locationButton.querySelector(".location-x");
            const spanY = locationButton.querySelector(".location-y");
            let icon = locationButton.querySelector("i.bi-trash");

            if (location) {
                // location이 존재하는 경우: 이미지, 제목, 좌표, 삭제 버튼 추가
                addMarker(location.locationX, location.locationY);
                imgTag.innerHTML = ''; // img-tag 초기화
                const img = document.createElement("img");
                img.src = location.locationPhoto;
                img.alt = "Location Photo";
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "cover";
                imgTag.appendChild(img);

                // 제목 및 날짜 정보 업데이트
                titleText.textContent = location.locationName;

                // 버튼을 표시하고 휴지통 아이콘 추가
                locationButton.style.display = "block";

                // 휴지통 아이콘 추가: 이미 추가된 경우 중복 방지
                if (!icon) {
                    icon = document.createElement("i");
                    icon.classList.add("bi", "bi-trash");
                    locationButton.appendChild(icon);
                }
                // 좌표 업데이트
                spanX.textContent = location.locationX != null ? location.locationX : "N/A";
                spanY.textContent = location.locationY != null ? location.locationY : "N/A";
            } else {
                // location이 없는 경우: 기본 구조로 설정
                imgTag.innerHTML = `
                <div class="btn btn-outline-secondary" id="img-container">
                    <i class="bi bi-plus"></i>
                </div>
                `;

                // 기본 제목과 설명 설정
                const titleText = locationDiv.querySelector(".card-title");
                titleText.textContent = "장소를 추가하세요.";

                // 버튼을 숨기고 좌표 초기화
                spanX.textContent = "";
                spanY.textContent = "";
                if (icon) {
                    icon.remove();
                }
                locationButton.style.display = "none";
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const nextButton = document.getElementById("nextPageBtn"); // 버튼 선택
        nextButton.addEventListener("click", function () {
            // 클릭 시 수행할 작업을 여기에 작성
            location.href = "/schedule/createSchedule";
            // 여기에 원하는 로직 추가
        });
    });

    appendMyLocation.addEventListener('click', (event) => {
        // 클릭된 요소가 .bi-trash 클래스를 가진 아이콘인지 확인
        const icon = event.target.closest('.bi-trash');
        if (icon) {
            // 아이콘이 속한 버튼 요소를 찾아 인덱스 가져오기
            const button = icon.closest('.btn-location');
            const cardBody = button.closest('.card-body');

            const cardBodies = Array.from(appendMyLocation.querySelectorAll('.card-body'));
            const index = cardBodies.indexOf(cardBody);

            // `card-body` 내부의 img-tag를 초기화
            const imgTag = cardBody.querySelector(".img-tag");
            imgTag.innerHTML = `
            <div class="btn btn-outline-secondary" id="img-container">
                <i class="bi bi-plus"></i>
            </div>
            `;

            // 텍스트 및 날짜 초기화
            const titleText = cardBody.querySelector(".card-title");
            titleText.textContent = "장소를 추가하세요.";

            // 좌표 초기화
            const spanX = button.querySelector(".location-x");
            const spanY = button.querySelector(".location-y");
            spanX.textContent = "";
            spanY.textContent = "";

            // 휴지통 아이콘 삭제 및 버튼 숨기기
            icon.remove();
            button.style.display = "none";

            // 인덱스에 따라 selectedItems 업데이트
            selectedItems[index] = null;
            const dataIndexList = selectedItems.map(item => item ? item.dataIndex : null);
            initializeButtons(addBtns);
            updateSelectedButtons(dataIndexList);
            modifyLocation(dataIndexList);

        }
    });

    function modifyLocation(dataIndexList) {
        fetch('/schedule/appendMyHotel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataIndexList)
        })
            .then(response => response.json()) // 응답 데이터를 JSON 형식으로 파싱
            .then(data => {
                renderLocationCards(data); // 받은 데이터를 이용해 카드 업데이트
                // dataIndexList를 순회하며 해당하는 버튼의 아이콘 업데이트
                dataIndexList.forEach(dataIndex => {
                });
            })
            .catch(error => {
                console.error("Error:", error);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('#locationListDiv .form-control');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const locationCards = document.querySelectorAll('#locationListDiv .card');

            locationCards.forEach(card => {
                const locationName = card.querySelector('.card-title').textContent.toLowerCase();
                const locationAddr = card.querySelector('.card-text').textContent.toLowerCase();

                // 장소 이름이나 주소에 검색어가 포함되어 있는지 확인
                if (locationName.includes(searchTerm) || locationAddr.includes(searchTerm)) {
                    card.style.display = ''; // 보이기
                } else {
                    card.style.display = 'none'; // 숨기기
                }
            });
        });

        // 검색창 초기화 버튼 추가 (선택적)
        const inputGroup = searchInput.parentElement;
        const clearButton = document.createElement('span');
        clearButton.className = 'input-group-text bg-white border-start-0 cursor-pointer';
        clearButton.innerHTML = '<i class="bi bi-x-lg text-muted"></i>';
        clearButton.style.cursor = 'pointer';
        clearButton.style.display = 'none'; // 초기에는 숨김

        // 입력 그룹에 클리어 버튼 추가
        inputGroup.appendChild(clearButton);

        // 입력 값이 있을 때만 클리어 버튼 표시
        searchInput.addEventListener('input', function() {
            clearButton.style.display = this.value ? 'flex' : 'none';
        });

        // 클리어 버튼 클릭 시 검색어 초기화 및 모든 카드 표시
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            clearButton.style.display = 'none';
            const locationCards = document.querySelectorAll('#locationListDiv .card');
            locationCards.forEach(card => {
                card.style.display = '';
            });
        });
    });


</script>
</body>
</html>
