<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
          name="viewport">
    <title>간단한 지도 표시하기</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"
            type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/mapUtils.js"></script>
    <style>
        .form-control:focus {
            border-color: #dee2e6 !important;  /* 기본 테두리 색상 유지 */
            box-shadow: none !important;
            outline: 0 !important;
        }
    </style>
</head>
<body>
<div class="container-fluid" style="height: 100vh;">
    <div class="row" style="height: 100vh;">
        <div class="col-4">
            <div class="row position-relative" style="height: 100vh;">
                <nav class="col-xl-3 pt-3 d-flex flex-column justify-content-between">
                    <div>
                        <h4 class="text-dark text-center">
                        <a href="/home" class="text-decoration-none text-dark">모두의<br>여행</a>
                        </h4>
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/selectDate')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/selectDate">날짜 선택</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/selectLocation')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/selectLocation">일정 선택</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/selectHotel')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/selectHotel">숙소 선택</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link text-center"
                                   data-th-classappend="${#strings.endsWith(#request.requestURI, '/schedule/createSchdule')} ? 'text-primary fw-bolder disabled' : 'text-dark'"
                                   href="/schedule/createSchdule">일정 확인</a>
                            </li>
                        </ul>
                    </div>
                    <div class="d-flex justify-content-center mb-4">
                        <button class="btn btn-primary btn-sm" id="nextPageBtn" type="button">다음</button>
                    </div>
                </nav>
                <div class="col-xl-9 " style="height: 100vh;">

                    <div class="d-flex justify-content-between align-items-start p-3">
                        <!-- 왼쪽 컨테이너: 텍스트 정보 -->
                        <div class="flex-grow-1">
                            <p class="fs-4 fw-bold mb-1" data-th-text="${trip.city.state.stateName} + ${trip.city.cityName}">제주도</p>
                            <p class="text-secondary mb-1" data-th-text="${trip.startDate} +' ~ '+  ${trip.endDate}">2024-01-01 ~ 2024-02-01</p>
                        </div>

                        <!-- 오른쪽 컨테이너: 버튼 -->
                        <div class="d-flex align-items-start">
                            <button class="btn btn-sm bg-dark text-white ms-2"
                                    data-bs-target="#appendMyLocation"
                                    data-bs-toggle="collapse">접기
                            </button>
                        </div>
                    </div>

                    <div class="container">
                        <div class="row">
                            <div class="col-md-6 d-flex justify-content-center mb-2">
                                <!-- 장소선택 버튼 -->
                                <button class="btn w-100 rounded-0 border border-top-0 border-start-0 border-end-0 border-primary"
                                        id="showLocationListBtn"
                                        type="button">장소선택
                                </button>
                            </div>

                            <div class="col-md-6 d-flex justify-content-center mb-2">
                                <!-- 장소추가 버튼 -->
                                <button class="btn w-100 rounded-0 border border-top-0 border-start-0 border-end-0"
                                        id="showAddLocationBtn"
                                        type="button">장소추가
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 위치 리스트 영역 -->
                    <div class="my-4" id="locationListDiv">
                        <!-- 검색창 영역 -->
                        <div class="input-group mb-3 shadow-sm focus-ring-0">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search text-muted"></i>
                            </span>
                            <input type="text"
                                   class="form-control border-start-0 focus-ring-0"
                                   placeholder="검색어를 입력하세요"
                                   aria-label="Search">
                        </div>

                        <!-- 스크롤될 리스트 영역 -->
                        <div style="height: calc(100vh - 250px); overflow-y: auto;">
                            <div class="mb-2" data-th-each="location, status : ${locationList}"
                                 data-th-object="${location}">
                                <div class="card" style="width: 100%; height: 100px;">
                                    <div class="card-body d-flex align-items-center justify-content-between gap-1 ">
                                        <!-- 이미지 영역 -->
                                        <img alt="Location Image" class="rounded me-3"
                                             data-th-src="${location.locationPhoto} ?: '/images/default.jpg'"
                                             style="width: 70px; height: 70px; object-fit: cover;">

                                        <!-- 텍스트 정보 영역 -->
                                        <div class="d-flex flex-column" style="flex: 1;">
                                            <h5 class="card-title mb-1" data-th-text="*{locationName}"
                                                style="font-size: 16px;">여행지이름</h5>
                                            <p class="card-text text-muted mb-0" data-th-text="*{locationAddr}"
                                               style="font-size: 12px;">주소</p>
                                        </div>

                                        <!-- 버튼 영역 -->
                                        <button class="btn btn-outline-secondary btn-location d-flex justify-content-center align-items-center"
                                                data-th-attr="data-index=${status.index}"
                                                style="height: 60px; width: 30px;">
                                            <i class="bi bi-plus-lg"></i>
                                            <span class="location-x d-none" data-th-text="*{locationX}"></span>
                                            <span class="location-y d-none" data-th-text="*{locationY}"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="my-1" id="addLocationDiv" style="width: 100%; overflow-y: auto; display: none;">
                        <div class="input-group mb-3 shadow-sm">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                            <input type="text" class="form-control border-start-0" placeholder="새로운 숙소를 검색해보세요" aria-label="Search">
                        </div>
                        <div class="d-flex justify-content-center mb-3">
                            <div id="addLocationMap" style="width: 500px; height: 300px;" class="border rounded shadow-sm"><p>지도영역</p></div>
                        </div>
                        <div class="mb-2">
                            <!-- 검색 결과가 여기에 표시될 것입니다 -->
                        </div>
                    </div>

                </div>
                <!-- 장소 추가 영역 -->
                <div class="col-xl-8 collapse show bg-white text-white position-absolute start-100 h-100"
                     id="appendMyLocation" style="z-index: 1; height: 100vh; overflow-y: auto;">
                    <!-- 왼쪽 컨테이너: 텍스트 정보 -->
                    <div class="p-3 d-flex align-items-end gap-3">
                        <p class="fs-4 fw-bold mb-1 text-dark" data-th-text="${#lists.isEmpty(selectLoList)} ? '0' : ${#lists.size(selectLoList)}">0</p>
                    </div>
                    <div id="cardArea">
<!--                        &lt;!&ndash; Thymeleaf를 사용한 초기 카드 렌더링 &ndash;&gt;-->
<!--                        <div data-th-each="location, status : ${selectLoList}" class="card mb-3" style="width: 100%; height: 100px;">-->
<!--                            <div class="card-body d-flex align-items-center justify-content-between border gap-2">-->
<!--                                &lt;!&ndash; 넘버링 서클 &ndash;&gt;-->
<!--                                <div class="d-flex justify-content-center align-items-center rounded-circle bg-primary text-white"-->
<!--                                     style="width: 20px; height: 20px; font-size: 10px;"-->
<!--                                     data-th-text="${status.count}">1</div>-->

<!--                                &lt;!&ndash; 이미지 영역 &ndash;&gt;-->
<!--                                <img class="rounded me-3 h-100" style="width: 70px; object-fit: cover;"-->
<!--                                     data-th-src="${location.locationPhoto} ?: '/images/default.jpg'"-->
<!--                                     alt="Location Image">-->

<!--                                &lt;!&ndash; 텍스트 정보 영역 &ndash;&gt;-->
<!--                                <div class="d-flex flex-column" style="flex: 1;">-->
<!--                                    <h5 class="card-title mb-1" style="font-size: 16px;"-->
<!--                                        data-th-text="${location.locationName}">여행지이름</h5>-->
<!--                                    <p class="card-text text-muted mb-0" style="font-size: 12px;"-->
<!--                                       data-th-text="${location.locationAddr}">주소</p>-->
<!--                                </div>-->

<!--                                &lt;!&ndash; 버튼 영역 &ndash;&gt;-->
<!--                                <button class="btn btn-outline-secondary btn-location d-flex justify-content-center align-items-center"-->
<!--                                        style="height: 60px; width: 30px;"-->
<!--                                        data-th-attr="data-index=${status.index}">-->
<!--                                    <i class="bi bi-trash"></i>-->
<!--                                    <span class="location-x d-none" data-th-text="${location.locationX}"></span>-->
<!--                                    <span class="location-y d-none" data-th-text="${location.locationY}"></span>-->
<!--                                </button>-->
<!--                            </div>-->
<!--                        </div>-->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-8 bg-white text-primary" id="map" style="height: 100vh;"></div>

        <div aria-hidden="true" aria-labelledby="dateModalLabel" class="modal fade" data-bs-backdrop="static"
             data-bs-keyboard="false"
             id="dateModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="dateModalLabel">여행지 정보 나타내기</h5>
                    </div>
                    <div class="modal-body">

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
<script data-th-inline="javascript">
    const locationListDiv = document.getElementById("locationListDiv");
    const addLocationDiv = document.getElementById('addLocationDiv');
    const showLocationListBtn = document.getElementById('showLocationListBtn');
    const showAddLocationBtn = document.getElementById('showAddLocationBtn');
    const addBtns = locationListDiv.querySelectorAll(".btn");
    const appendMyLocation = document.getElementById("appendMyLocation");

    let selectedItems = [];

    document.addEventListener('DOMContentLoaded', () => {
        const stateName = /*[[${trip.city.state.stateName}]]*/ '';
        const cityName = /*[[${trip.city.cityName}]]*/ '';

        // 지도 초기화
        initializeMap('map', stateName, cityName);
    });

    document.addEventListener('DOMContentLoaded', function() {

        // 숙소선택 버튼 클릭 이벤트
        showLocationListBtn.addEventListener('click', function() {
            // 화면 전환
            locationListDiv.style.display = 'block';
            addLocationDiv.style.display = 'none';

            // 버튼 스타일 변경
            showLocationListBtn.classList.add('border-primary');
            showAddLocationBtn.classList.remove('border-primary');
        });

        // 숙소추가 버튼 클릭 이벤트
        showAddLocationBtn.addEventListener('click', function() {
            // 화면 전환
            locationListDiv.style.display = 'none';
            addLocationDiv.style.display = 'block';

            // 버튼 스타일 변경
            showLocationListBtn.classList.remove('border-primary');
            showAddLocationBtn.classList.add('border-primary');
        });

        // 초기 상태 설정 (locationListDiv가 보이도록)
        locationListDiv.style.display = 'block';
        addLocationDiv.style.display = 'none';
        showLocationListBtn.classList.add('border-primary');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const collapseButton = document.querySelector('[data-bs-target="#appendMyLocation"]');
        const appendMyLocation = document.getElementById('appendMyLocation');

        // collapse 이벤트 리스너 추가
        appendMyLocation.addEventListener('show.bs.collapse', function () {
            collapseButton.textContent = '접기';
        });

        appendMyLocation.addEventListener('hide.bs.collapse', function () {
            collapseButton.textContent = '펼치기';
        });
    });

    // // 페이지 로드 시 초기 selectedItems 설정
    // document.addEventListener('DOMContentLoaded', function() {
    //     // Thymeleaf로 전달된 selectLoList의 인덱스들을 selectedItems에 추가
    //     const initialSelectedButtons = document.querySelectorAll('#locationListDiv .btn-location[data-index]');
    //     initialSelectedButtons.forEach(button => {
    //         const index = button.getAttribute('data-index');
    //         if(index) {
    //             selectedItems.push(index);
    //             // 버튼 스타일도 선택된 상태로 변경
    //             button.classList.remove("btn-outline-secondary");
    //             button.classList.add("btn-primary");
    //             const icon = button.querySelector('i');
    //             if(icon) {
    //                 icon.classList.remove("bi-plus-lg");
    //                 icon.classList.add("bi-check-lg");
    //             }
    //         }
    //     });
    // });

    addBtns.forEach(button => {
        button.addEventListener('click', () => {
            const locationX = button.querySelector('.location-x').textContent;
            const locationY = button.querySelector('.location-y').textContent;
            const index = button.getAttribute("data-index");
            const icon = button.querySelector('i');

            button.classList.remove("btn-outline-secondary");
            button.classList.add("btn-primary");

            icon.classList.remove("bi-plus-lg");
            icon.classList.add("bi-check-lg");

            selectedItems.push(index);
            modifyLocation(selectedItems);
        });
    });

    function modifyLocation(selectedItems) {
        fetch('/schedule/appendMyLocation', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(selectedItems)
        })
            .then(response => response.json()) // 응답 데이터를 JSON 형식으로 파싱
            .then(data => {
                renderLocationCards(data); // 받은 데이터를 이용해 카드 업데이트
            })
            .catch(error => {
                console.error("Error:", error);
            });
    }

    function renderLocationCards(data) {
        const cardArea = document.getElementById("cardArea");
        const countElement = document.querySelector('#appendMyLocation .fs-4.fw-bold');

        // 선택된 장소 수 업데이트
        countElement.textContent = data.length;

        // 카드 영역 초기화
        cardArea.innerHTML = '';

        // markerList의 모든 마커를 지도에서 제거
        markerList.forEach(marker => {
            marker.setMap(null);
        });
        markerList = [];

        // 반환된 selectLoList 배열을 순회하며 동적으로 HTML 생성
        data.forEach((location, index) => {
            const locationDiv = document.createElement("div");
            locationDiv.classList.add("card", "mb-3");
            locationDiv.style.width = "100%";
            locationDiv.style.height = "100px";

            // Card Body
            const cardBody = document.createElement("div");
            cardBody.classList.add("card-body", "d-flex", "align-items-center", "justify-content-between", "border", "gap-2");

            // 넘버링 서클
            const numberCircle = document.createElement("div");
            numberCircle.classList.add("d-flex", "justify-content-center", "align-items-center", "rounded-circle", "bg-primary", "text-white");
            numberCircle.style.width = "20px";
            numberCircle.style.height = "20px";
            numberCircle.style.fontSize = "10px";
            numberCircle.textContent = index + 1;

            // 이미지 영역
            const image = document.createElement("img");
            image.classList.add("rounded", "me-3", "h-100");
            image.alt = "Location Image";
            image.src = location.locationPhoto || '/images/default.jpg';
            image.style.width = "70px";
            image.style.objectFit = "cover";

            // 텍스트 정보 영역
            const textContainer = document.createElement("div");
            textContainer.classList.add("d-flex", "flex-column");
            textContainer.style.flex = "1";

            const title = document.createElement("h5");
            title.classList.add("card-title", "mb-1");
            title.style.fontSize = "16px";
            title.textContent = location.locationName;

            const addr = document.createElement("p");
            addr.classList.add("card-text", "text-muted", "mb-0");
            addr.style.fontSize = "12px";
            addr.textContent = location.locationAddr;

            textContainer.appendChild(title);
            textContainer.appendChild(addr);

            // 버튼 영역
            const button = document.createElement("button");
            button.classList.add("btn", "btn-outline-secondary", "btn-location", "d-flex", "justify-content-center", "align-items-center");
            button.style.height = "60px";
            button.style.width = "30px";
            button.setAttribute("data-index", index);

            const icon = document.createElement("i");
            icon.classList.add("bi", "bi-trash");
            button.appendChild(icon);

            const spanX = document.createElement("span");
            spanX.classList.add("location-x", "d-none");
            spanX.textContent = location.locationX;
            button.appendChild(spanX)

            const spanY = document.createElement("span");
            spanY.classList.add("location-y", "d-none");
            spanY.textContent = location.locationY;
            button.appendChild(spanY);

            // Card Body에 구성 요소 추가
            cardBody.appendChild(numberCircle);
            cardBody.appendChild(image);
            cardBody.appendChild(textContainer);
            cardBody.appendChild(button);

            // locationDiv에 cardBody 추가
            locationDiv.appendChild(cardBody);

            // cardArea에 locationDiv 추가
            cardArea.appendChild(locationDiv);

            // 마커 추가
            if (location.locationX && location.locationY) {
                addMarker(location.locationX, location.locationY);
            }
        });
    }


    appendMyLocation.addEventListener('click', (event) => {
        // 버튼 또는 휴지통 아이콘이 클릭되었을 때
        if (event.target.classList.contains("btn") || event.target.classList.contains("bi-trash")) {
            // 가장 가까운 .btn-location 버튼 찾기
            const button = event.target.closest(".btn-location");

            if (button) {
                const index = button.getAttribute("data-index");
                console.log("Button/Icon clicked with index:", index);
                // 삭제될 인덱스의 값을 미리 저장
                const removedValue = selectedItems[index];
                // 배열에서 해당 인덱스 제거
                selectedItems.splice(index, 1);
                modifyLocation(selectedItems);
                console.log(selectedItems);
                // 삭제된 값으로 상태 변경
                stateChange(removedValue);
            }
        }
    });

    function stateChange(index) {
        // 모든 버튼 중에서 해당 data-index를 가진 버튼 찾기
        const button = document.querySelector(`.btn-location[data-index="${index}"]`);

        if (button) {
            // 버튼 스타일 변경
            button.classList.remove("btn-primary");
            button.classList.add("btn-outline-secondary");

            // 아이콘 변경
            const icon = button.querySelector('i');
            if (icon) {
                icon.classList.remove("bi-check-lg");
                icon.classList.add("bi-plus-lg");
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        const nextButton = document.getElementById("nextPageBtn"); // 버튼 선택

        nextButton.addEventListener("click", function () {
            // 클릭 시 수행할 작업을 여기에 작성
            location.href = "/schedule/selectHotel";
            // 여기에 원하는 로직 추가
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('#locationListDiv .form-control');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            const locationCards = document.querySelectorAll('#locationListDiv .card');

            locationCards.forEach(card => {
                const locationName = card.querySelector('.card-title').textContent.toLowerCase();
                const locationAddr = card.querySelector('.card-text').textContent.toLowerCase();

                // 장소 이름이나 주소에 검색어가 포함되어 있는지 확인
                if (locationName.includes(searchTerm) || locationAddr.includes(searchTerm)) {
                    card.style.display = ''; // 보이기
                } else {
                    card.style.display = 'none'; // 숨기기
                }
            });
        });

        // 검색창 초기화 버튼 추가 (선택적)
        const inputGroup = searchInput.parentElement;
        const clearButton = document.createElement('span');
        clearButton.className = 'input-group-text bg-white border-start-0 cursor-pointer';
        clearButton.innerHTML = '<i class="bi bi-x-lg text-muted"></i>';
        clearButton.style.cursor = 'pointer';
        clearButton.style.display = 'none'; // 초기에는 숨김

        // 입력 그룹에 클리어 버튼 추가
        inputGroup.appendChild(clearButton);

        // 입력 값이 있을 때만 클리어 버튼 표시
        searchInput.addEventListener('input', function() {
            clearButton.style.display = this.value ? 'flex' : 'none';
        });

        // 클리어 버튼 클릭 시 검색어 초기화 및 모든 카드 표시
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            clearButton.style.display = 'none';
            const locationCards = document.querySelectorAll('#locationListDiv .card');
            locationCards.forEach(card => {
                card.style.display = '';
            });
        });
    });
</script>
</body>
</html>
