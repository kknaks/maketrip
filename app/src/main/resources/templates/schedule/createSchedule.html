<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=0zojwabqn9&submodules=geocoder"
            type="text/javascript"></script>
    <title>Document</title>
    <style>
        #drag-handle {
            cursor: ew-resize;
            width: 10px;
            height: 100%;
        }

        .column-item {
            flex: 0 0 300px;
            min-width: 300px;
            padding: 8px;
        }

    </style>
</head>
<body>
<div class="d-flex" style="width: 100%; height: 100vh;">
    <!-- 왼쪽 리스트 부분 -->
    <nav class="p-2 text-center "
         style="width: 100px; flex: 0 0 100px;">
        <h4 class="text-dark">모두의<br>여행</h4>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link text-dark text-center" href="/home">메뉴 1</a></li>
            <li class="nav-item"><a class="nav-link text-dark text-center" href="#">메뉴 2</a></li>
            <li class="nav-item"><a class="nav-link text-dark text-center" href="#">메뉴 3</a></li>
            <li class="nav-item"><a class="nav-link text-dark text-center" href="#">메뉴 4</a></li>
        </ul>
        <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-primary btn-sm" data-bs-target="#editModal" data-bs-toggle="modal" type="button">
                일정 편집
            </button>
        </div>
        <div class="d-flex justify-content-center mt-4">
            <button class="btn btn-primary btn-sm" id="nextPageBtn"
                    type="button">다음
            </button>
        </div>
    </nav>


    <!-- 왼쪽 패널 -->
    <div class="overflow-auto bg-white h-100" id="left-panel">
        <div class="flex-column p-3">
            <p class="fs-4 fw-bold mb-1" data-th-text="${stateName} + ${cityName}">제주도</p>
            <p class="text-secondary mb-1" data-th-text="${startDate} +' ~ '+  ${endDate}">2024-01-01 ~ 2024-02-01</p>
        </div>


        <div class="d-flex flex-nowrap h-100 overflow-auto" id="columns-container">
            <!-- Day 컬럼 -->
            <div class="column-item text-dark p-1" style="width: 300px; min-width: 300px;"
                 th:each="i : ${#numbers.sequence(1, totalDay)}">
                <div class="fw-bold mb-2" th:text="'Day ' + ${i}">Day 1</div>
                <!-- 드래그 앤 드롭을 위한 전용 컨테이너 -->
                <div class="schedule-container d-flex flex-column gap-1">
                    <div class="card border-0" style="width: 100%; height: 100px; position: relative;"
                         th:each="schedule : ${tripScheduleList}"
                         th:if="${schedule.scheduleDay == i}">
                        <div class="d-flex align-items-start gap-1 mt-1" style="height: 100%;">
                            <div class="position-relative d-flex flex-column align-items-center"
                                 style="height: 100%;">
                                <div class="m-2 d-flex justify-content-center align-items-center rounded-circle bg-primary text-white"
                                     data-th-text="${schedule.scheduleRoute}"
                                     style="width: 20px; height: 20px; font-size: 10px;">
                                </div>
                                <div class="position-absolute bg-secondary"
                                     style="width: 2px; height: calc(100% - 30px); top: 30px; left: 50%; transform: translateX(-50%);">
                                </div>
                            </div>
                            <div class="d-flex flex-column align-items-start mt-2">
                                <p class="mb-0 bg-info rounded text-white p-1" style="font-size: 12px;">관광명소</p>
                                <p class="fs-6 fw-bold mb-0" th:text="${schedule.location.locationName}">
                                    관광지이름</p>
                            </div>
                            <img alt="Location Image" class="rounded me-3 h-100 ms-auto"
                                 src="image/default.png" style="width: 60px; object-fit: cover;"
                                 th:src="${schedule.location.locationPhoto}">
                            <span class="day d-none" th:text="${schedule.scheduleDay}"></span>
                            <span class="route d-none" th:text="${schedule.scheduleRoute}"></span>
                            <span class="schedule-no d-none" th:text="${schedule.scheduleNo}"></span>
                            <span class="location-x d-none" th:text="${schedule.location.locationX}"></span>
                            <span class="location-y d-none" th:text="${schedule.location.locationY}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 조정 핸들러 -->
    <div class="position-relative bg-white" id="drag-handle">
        <div>
            <i class="bi bi-arrows-expand-vertical" id="drag-button"></i>
        </div>

        <div class="container border rounded-end bg-white d-flex justify-content-center align-items-center position-absolute start-100">
            <i class="bi bi-arrow-bar-right m-0" id="expend" style="z-index: 1;"></i>
        </div>
    </div>

    <!-- 오른쪽 콘텐츠 부분 -->
    <div class="flex-grow-1 p-3" id="map" style="height: 100vh;"></div>

    <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="min-width: 80%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myModalLabel">일정 편집</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <!-- 컬럼 컨테이너가 여기에 복사됨 -->
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">닫기</button>
                    <button class="btn btn-primary" id="saveButton" type="button">저장</button>
                </div>
            </div>
        </div>
    </div>

    <div aria-hidden="true" aria-labelledby="completionModalLabel" class="modal fade" id="completionModal"
         tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="completionModalLabel">저장 완료</h5>
                    <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body text-center">
                    <p>일정이 성공적으로 저장되었습니다!</p>
                    <div class="d-grid gap-2">
                        <a class="btn btn-primary" href="/home">홈으로</a>
                        <a class="btn btn-secondary" href="/mypage">마이페이지</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script data-th-inline="javascript">
    const leftPanel = document.getElementById('left-panel');
    const rightPanel = document.getElementById('map');
    const columnsContainer = document.getElementById('columns-container');
    const dragHandle = document.getElementById('drag-handle');
    let isDragging = false;
    const columnWidth = '300';

    function calculateMaxWidth() {
        let columnCount = columnsContainer.children.length;
        if (columnCount >= 3) {
            columnCount = 3;
        }
        return (columnCount * columnWidth) + `px`;
    }

    // 컬럼 수에 따라 leftPanel의 너비를 조정하는 함수
    function adjustPanelWidth() {
        const columnCount = columnsContainer.children.length;
        if (columnCount === 1) {
            leftPanel.style.width = calculateMaxWidth();
            rightPanel.style.width = `calc(100% - 410px)`; // 300px + 왼쪽 리스트 100px + drag-handle 5px
            columnsContainer.classList.add('flex-wrap');
            columnsContainer.classList.remove('flex-nowrap');
        } else if (columnCount === 2) {
            leftPanel.style.width = calculateMaxWidth();
            rightPanel.style.width = `calc(100% - 710px)`; // 600px + 왼쪽 리스트 100px + drag-handle 5px
            columnsContainer.classList.add('flex-nowrap');
            columnsContainer.classList.remove('flex-wrap');
        } else {
            leftPanel.style.width = calculateMaxWidth();
            rightPanel.style.width = `calc(100% - 1010px)`; // 900px + 왼쪽 리스트 100px + drag-handle 5px
            columnsContainer.classList.add('flex-nowrap');
            columnsContainer.classList.remove('flex-wrap');
        }
    }

    // 마우스 다운 이벤트
    dragHandle.addEventListener('mousedown', () => {
        isDragging = true;
        document.body.style.cursor = 'ew-resize';
    });

    // 마우스 움직임 이벤트 (드래그 중에 패널 너비 조정)
    document.addEventListener('mousemove', (e) => {

        if (isDragging) {
            const newWidth = e.clientX - leftPanel.getBoundingClientRect().left;
            if (newWidth <= 900) {
                leftPanel.style.width = columnWidth + 'px';
                rightPanel.style.width = `calc(100% - 410px)`;
                columnsContainer.classList.add('flex-wrap');
                columnsContainer.classList.remove('flex-nowrap');
                isExpanded = false;
            } else if (newWidth > 300) {
                leftPanel.style.width = calculateMaxWidth();
                rightPanel.style.width = `calc(100% - 1010px)`;
                columnsContainer.classList.add('flex-nowrap');
                columnsContainer.classList.remove('flex-wrap');
                isExpanded = true;
            }
        }
    });

    // 패널의 초기 너비 설정
    let isExpanded = false;  // 상태 추적 변수

    dragHandle.addEventListener('click', () => {
        if (isExpanded) {
            // 패널이 확장되어 있을 때 축소
            leftPanel.style.width = '300px';
            rightPanel.style.width = `calc(100% - 405px)`;  // 300px + left list 100px + drag handle 5px
            columnsContainer.classList.add('flex-wrap');
            columnsContainer.classList.remove('flex-nowrap');
            isDragging = false;
        } else {
            // 패널이 축소되어 있을 때 확장
            leftPanel.style.width = calculateMaxWidth();
            rightPanel.style.width = `calc(100% - 1005px)`; // 900px + left list 100px + drag handle 5px
            columnsContainer.classList.add('flex-nowrap');
            columnsContainer.classList.remove('flex-wrap');
        }
        isExpanded = !isExpanded;  // 상태 반전
    });
    // 마우스 업 이벤트
    document.addEventListener('mouseup', () => {
        isDragging = false;
        document.body.style.cursor = 'default';
    });

    // 페이지 로드 시 초기 너비 설정
    document.addEventListener('DOMContentLoaded', adjustPanelWidth);


    // 줌 레벨을 반환하는 함수
    function getZoomByRegionType(regionType) {
        const zoomLevels = {
            'area1': 11,  // 시/도
            'area2': 13,  // 시/군/구
            'area3': 15,  // 읍/면/동
            'area4': 17   // 리
        };
        return zoomLevels[regionType] || 13;
    }


    function addMarker(locationX, locationY) {
        console.log("add location mark : ", locationX, locationY);
        let pos = new naver.maps.LatLng(locationY, locationX);
        let marker = new naver.maps.Marker({
            position: pos,
            map: map,
        });

        // 마커에 위치 속성 추가하여 나중에 참조 가능
        marker.locationX = locationX;
        marker.locationY = locationY;

        // markerList에 추가
        markerList.push(marker);
    }

    // 전역 변수로 지도 객체 선언
    let map = null;

    // 줌 레벨 상수
    const ZOOM_LEVELS = {
        'area1': 11,  // 시/도
        'area2': 13,  // 시/군/구
        'area3': 15,  // 읍/면/동
        'area4': 17   // 리
    };

    // DOM 로드 시 지도 초기화
    document.addEventListener('DOMContentLoaded', () => {
        // Thymeleaf 변수
        const stateName = /*[[${trip.city.state.stateName}]]*/ '';
        const cityName = /*[[${trip.city.cityName}]]*/ '';
        let regionType = 'area1';

        // 도시명이 '전체'인 경우 처리
        const searchQuery = cityName === "전체" ? stateName : cityName;

        // 주소 검색 및 지도 초기화
        naver.maps.Service.geocode({
            query: searchQuery
        }, function (status, response) {
            if (status !== naver.maps.Service.Status.OK) {
                console.error('지도 초기화 실패');
                return;
            }

            const items = response.v2.addresses;
            if (items.length === 0) {
                console.error('주소를 찾을 수 없습니다');
                return;
            }

            const {x: mapx, y: mapy} = items[0];
            const centerPosition = new naver.maps.LatLng(mapy, mapx);
            const zoomLevel = ZOOM_LEVELS[regionType] || ZOOM_LEVELS.area2;

            // 지도가 없으면 새로 생성, 있으면 위치만 업데이트
            if (!map) {
                map = new naver.maps.Map('map', {
                    center: centerPosition,
                    zoom: zoomLevel
                });
            } else {
                map.setCenter(centerPosition);
                map.setZoom(zoomLevel);
            }
            pinMarker();
        });
    })

    let markerList = [];

    function pinMarker() {
        // 모든 card 요소를 탐색
        const cards = document.querySelectorAll('#columns-container .card');

        cards.forEach(card => {
            // card 내부의 x와 y 좌표 추출
            const locationX = card.querySelector('.location-x').textContent;
            const locationY = card.querySelector('.location-y').textContent;

            // 유효한 x, y 좌표가 있는 경우 addMarker 함수 호출
            if (locationX && locationY) {
                addMarker(parseFloat(locationX), parseFloat(locationY));
            }
        });
    }
    const themas = /*[[${themas}]]*/ [];
    document.getElementById("nextPageBtn").addEventListener("click", function () {
        const editModal = document.getElementById('editModal');
        const modalContent = document.getElementById('modalContent');
        const modalTitle = document.getElementById('myModalLabel');

        modalTitle.textContent = '여행 정보 입력';

        // 모달 내용 설정
        modalContent.innerHTML = `
    <form action='/schedule/save' id="tripForm" method="post" class="p-4">
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="tripTitle" class="form-label">여행 제목</label>
                <input type="text" class="form-control form-control-sm" id="tripTitle" name="tripTitle" required>
            </div>
            <div class="col-md-6">
                <label for="themaNo" class="form-label">여행 테마</label>
                <select name="themaNo" id="themaNo" class="form-select form-select-sm" required>
                    <option value="">테마 선택</option>
                    ${themas.map(thema =>
            `<option value="${thema.themaNo}">${thema.themaName}</option>`
        ).join('')}
                </select>
            </div>
        </div>
    </form>`;

        // 저장 버튼 이벤트 리스너 추가
        document.getElementById('saveButton').addEventListener('click', function saveNextModal() {
            const form = document.getElementById('tripForm');
            const formData = new FormData(form);

            // 스케줄 데이터 수집
            const updatedSchedules = [];
            const scheduleContainers = document.querySelectorAll('#columns-container .schedule-container');

            scheduleContainers.forEach((container, dayIndex) => {
                const cards = container.querySelectorAll('.card');
                cards.forEach((card) => {
                    const schedule = {
                        scheduleNo: parseInt(card.querySelector('.schedule-no').textContent),
                        scheduleDay: parseInt(card.querySelector('.day').textContent),
                        scheduleRoute: parseInt(card.querySelector('.route').textContent),
                    };
                    updatedSchedules.push(schedule);
                });
            });

            // 스케줄 데이터 전송
            fetch('/schedule/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updatedSchedules)
            })
                .then(response => {
                    if (response.ok) {
                        const editModalInstance = bootstrap.Modal.getInstance(editModal);
                        editModalInstance.hide(); // 기존 모달 닫기

                        const completionModal = new bootstrap.Modal(document.getElementById('completionModal'));
                        completionModal.show();

                        // FormData를 서버로 전송
                        fetch('/schedule/save', {
                            method: 'POST',
                            body: formData
                        })
                            .then(response => {
                                if (response.ok) {
                                    // 완료 모달 표시
                                    const completionModal = new bootstrap.Modal(document.getElementById('completionModal'));
                                    completionModal.show();
                                }
                            })
                            .catch(error => console.error('Error:', error));
                    }
                })

            document.getElementById('saveButton').removeEventListener('click', saveNextModal);
        });

        // 모달 보이기
        const modal = new bootstrap.Modal(editModal);
        modal.show();
    });

    document.querySelector('[data-bs-target="#editModal"]').addEventListener('click', function () {
        const editModal = document.getElementById('editModal');
        const modalContent = document.getElementById('modalContent');

        modalContent.innerHTML = '';
        const originalContainer = document.getElementById('columns-container');
        const clonedContainer = originalContainer.cloneNode(true);
        modalContent.appendChild(clonedContainer);
        initializeDragAndDrop(modalContent);

        document.getElementById('saveButton').addEventListener('click', function saveEditModal() {
            const modalContainer = document.querySelector('#modalContent #columns-container');
            const originalContainer = document.getElementById('columns-container');
            originalContainer.innerHTML = modalContainer.innerHTML;
            pinMarker();
            bootstrap.Modal.getInstance(editModal).hide();

            document.getElementById('saveButton').removeEventListener('click', saveEditModal);
        });
    });

    function initializeDragAndDrop(modalContent) {
        const cards = modalContent.querySelectorAll('.card');
        const scheduleContainers = modalContent.querySelectorAll('.schedule-container');
        let dragStartContainer = null;
        let dragStartIndex = null;

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return {offset: offset, element: child};
                } else {
                    return closest;
                }
            }, {offset: Number.NEGATIVE_INFINITY}).element;
        }

        function updateCardData() {
            modalContent.querySelectorAll('.schedule-container').forEach((container, columnIndex) => {
                const dayNumber = columnIndex + 1;
                const cards = container.querySelectorAll('.card');

                cards.forEach((card, cardIndex) => {
                    const routeNumber = cardIndex;

                    const numberCircle = card.querySelector('.rounded-circle');
                    if (numberCircle) {
                        numberCircle.textContent = routeNumber.toString();
                    }

                    const daySpan = card.querySelector('.day');
                    const routeSpan = card.querySelector('.route');

                    if (daySpan) {
                        daySpan.textContent = dayNumber.toString();
                    }
                    if (routeSpan) {
                        routeSpan.textContent = routeNumber.toString();
                    }
                });
            });
        }

        function isValidDrop(draggingCard, targetContainer, afterElement) {
            const draggingRoute = parseInt(draggingCard.querySelector('.route').textContent);
            let targetPosition;

            if (afterElement) {
                const cards = [...targetContainer.querySelectorAll('.card')];
                targetPosition = cards.indexOf(afterElement);
            } else {
                targetPosition = targetContainer.querySelectorAll('.card').length;
            }

            if (draggingRoute !== 0 && targetPosition === 0) {
                return false;
            }

            if (draggingRoute === 0 && targetPosition !== 0) {
                return false;
            }

            return true;
        }

        function resetDraggedCard() {
            const draggingCard = modalContent.querySelector('.dragging');
            if (!draggingCard || !dragStartContainer) return;

            const cards = [...dragStartContainer.querySelectorAll('.card')];

            if (dragStartIndex === 0) {
                dragStartContainer.insertBefore(draggingCard, cards[0]);
            } else if (dragStartIndex >= cards.length) {
                dragStartContainer.appendChild(draggingCard);
            } else {
                dragStartContainer.insertBefore(draggingCard, cards[dragStartIndex]);
            }

            updateCardData();
        }

        // 카드에 드래그 이벤트 추가
        cards.forEach(card => {
            card.setAttribute('draggable', 'true');

            card.addEventListener('dragstart', (e) => {
                card.classList.add('dragging');
                dragStartContainer = card.closest('.schedule-container');
                dragStartIndex = [...dragStartContainer.querySelectorAll('.card')].indexOf(card);
            });

            card.addEventListener('dragend', (e) => {
                card.classList.remove('dragging');
                modalContent.querySelectorAll('.drag-over').forEach(el =>
                    el.classList.remove('drag-over')
                );
            });
        });

        // // 컨테이너에 드래그 이벤트 추가
        // scheduleContainers.forEach(container => {
        //     container.addEventListener('dragover', e => {
        //         e.preventDefault();
        //         const draggable = modalContent.querySelector('.dragging');
        //         if (!draggable) return;
        //
        //         const afterElement = getDragAfterElement(container, e.clientY);
        //
        //         if (!isValidDrop(draggable, container, afterElement)) {
        //             e.dataTransfer.dropEffect = 'none';
        //             return;
        //         }
        //
        //         container.classList.add('drag-over');
        //
        //         if (afterElement) {
        //             container.insertBefore(draggable, afterElement);
        //         } else {
        //             container.appendChild(draggable);
        //         }
        //     });
        //
        //     container.addEventListener('drop', e => {
        //         e.preventDefault();
        //         const draggable = modalContent.querySelector('.dragging');
        //         if (!draggable) return;
        //
        //         const afterElement = getDragAfterElement(container, e.clientY);
        //
        //         if (!isValidDrop(draggable, container, afterElement)) {
        //             resetDraggedCard();
        //             // 경고 모달 표시 (필요한 경우)
        //             e.stopPropagation();
        //             return false;
        //         }
        //
        //         container.classList.remove('drag-over');
        //         updateCardData();
        //     });
        //
        //     container.addEventListener('dragleave', e => {
        //         if (e.relatedTarget && container.contains(e.relatedTarget)) return;
        //         container.classList.remove('drag-over');
        //     });
        // });
        scheduleContainers.forEach(container => {
            container.addEventListener('dragover', e => {
                e.preventDefault();
                const draggable = modalContent.querySelector('.dragging');
                if (!draggable) return;

                const afterElement = getDragAfterElement(container, e.clientY);

                if (!isValidDrop(draggable, container, afterElement)) {
                    e.dataTransfer.dropEffect = 'none';
                    return;
                }

                container.classList.add('drag-over');

                if (afterElement) {
                    container.insertBefore(draggable, afterElement);
                } else {
                    container.appendChild(draggable);
                }

                // 드래그오버 시점에서도 업데이트 실행
                modalContent.querySelectorAll('.schedule-container').forEach((container, columnIndex) => {
                    const dayNumber = columnIndex + 1;
                    const cards = container.querySelectorAll('.card');

                    cards.forEach((card, cardIndex) => {
                        const routeNumber = cardIndex;

                        const numberCircle = card.querySelector('.rounded-circle');
                        if (numberCircle) {
                            numberCircle.textContent = routeNumber.toString();
                        }

                        const daySpan = card.querySelector('.day');
                        const routeSpan = card.querySelector('.route');

                        if (daySpan) {
                            daySpan.textContent = dayNumber.toString();
                        }
                        if (routeSpan) {
                            routeSpan.textContent = routeNumber.toString();
                        }
                    });
                });
            });

            container.addEventListener('drop', e => {
                e.preventDefault();
                const draggable = modalContent.querySelector('.dragging');
                if (!draggable) return;

                const afterElement = getDragAfterElement(container, e.clientY);

                if (!isValidDrop(draggable, container, afterElement)) {
                    resetDraggedCard();
                    e.stopPropagation();
                    return false;
                }

                container.classList.remove('drag-over');

                // drop 시점에서도 업데이트 실행
                modalContent.querySelectorAll('.schedule-container').forEach((container, columnIndex) => {
                    const dayNumber = columnIndex + 1;
                    const cards = container.querySelectorAll('.card');

                    cards.forEach((card, cardIndex) => {
                        const routeNumber = cardIndex;

                        const numberCircle = card.querySelector('.rounded-circle');
                        if (numberCircle) {
                            numberCircle.textContent = routeNumber.toString();
                        }

                        const daySpan = card.querySelector('.day');
                        const routeSpan = card.querySelector('.route');

                        if (daySpan) {
                            daySpan.textContent = dayNumber.toString();
                        }
                        if (routeSpan) {
                            routeSpan.textContent = routeNumber.toString();
                        }
                    });
                });
            });

            // ... 나머지 코드 동일 ...
        });
    }


</script>
</body>
</html>
