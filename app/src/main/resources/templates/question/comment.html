<div class="container my-2" style="width: 1200px; margin: 0 auto;">
    <form data-th-action="@{/comment/add}" method="post" class="mb-3">
        <textarea name="commentContent" class="form-control mb-1"  rows="5" style="width: 100%; resize: none;" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        <input type="hidden" name="boardType" value="1">
        <input type="hidden" name="boardNo" data-th-value="${board.boardNo}">
        <button type="submit" class="btn btn-secondary">ëŒ“ê¸€ ë“±ë¡</button>
    </form>

    <div class="mb-3">
        <select id="commentSort" class="form-select w-auto" onchange="changeCommentSort()">
            <option value="registered" data-th-selected="${sort == 'registered'}">ë“±ë¡ìˆœ</option>
            <option value="likes" data-th-selected="${sort == 'likes'}">ì¢‹ì•„ìš”ìˆœ</option>
        </select>
    </div>

    <p data-th-unless="${commentList}">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>

    <ul class="list-unstyled" data-th-if="${commentList != null and commentList.size() > 0}">
        <li class="mb-1" data-th-each="comment : ${commentList}">
            <div class="p-3 border rounded shadow-sm bg-white"> <!-- ë°•ìŠ¤ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ -->
                <div class="d-flex align-items-center mb-2">
                    <img data-th-src="${board.writer.userPhoto != null ? board.writer.userPhoto : 'https://via.placeholder.com/60x60'}"
                         alt="User Photo" class="rounded-circle me-3" style="width: 60px; height: 60px;">
                    <strong class="me-2" data-th-text="${board.writer.userNickname}">ë‹‰ë„¤ì„</strong>
                    <small class="text-muted" data-th-text="${#calendars.format(comment.commentCreatedDate, 'yyyyë…„ MMì›” ddì¼ HH:mm')}">ì‘ì„±ì¼</small>
                </div>

                <textarea class="form-control mb-2" readonly rows="1" style="overflow: hidden; resize: none; border: none; background-color: transparent;"
                          data-th-text="${comment.commentContent}"
                          oninput="adjustTextareaHeight(this)">ëŒ“ê¸€ ë‚´ìš©</textarea>

                <div class="d-flex align-items-center">
                    <button type="button"
                            class="btn btn-outline-danger btn-sm me-2"
                            data-th-id="'commentLikeButton-' + ${comment.commentNo}"
                            data-th-onclick="|toggleCommentLike(${comment.commentNo})|"
                            data-th-text="${commentLikedMap[comment.commentNo] != null && commentLikedMap[comment.commentNo] ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”'}">
                    </button>
                    <span data-th-id="'commentLikeCount-' + ${comment.commentNo}" class="me-2" data-th-text="${comment.commentLike}">0</span>
                    <div data-th-if="${isLoggedIn and comment.userNo == loginUserNo}">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="enableEdit(this)">ìˆ˜ì •</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" data-th-onclick="|updateComment(${comment.commentNo}, ${board.boardNo}, this)|" style="display: none;">ì €ì¥</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="cancelEdit(this)" style="display: none;">ì·¨ì†Œ</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-th-onclick="|deleteComment(${comment.commentNo}, ${board.boardNo})|">ì‚­ì œ</button>
                    </div>
                </div>
            </div>
        </li>
    </ul>

    <div class="text-center">
    <span data-th-if="${currentPage > 1}">
        <a class="btn btn-outline-secondary btn-sm" data-th-href="@{|?boardNo=${board.boardNo}&page=${currentPage - 1}|}">
            [ì´ì „]
        </a>
    </span>
        <span data-th-unless="${currentPage > 1}" class="btn btn-outline-secondary btn-sm disabled">[ì´ì „]</span>

        <span data-th-each="i : ${#numbers.sequence(1, totalPages)}">
        <a class="btn btn-outline-secondary btn-sm"
           data-th-href="@{|?boardNo=${board.boardNo}&page=${i}|}"
           data-th-classappend="${i == currentPage} ? ' active' : ''"
           data-th-text="${i}">
           1
        </a>
    </span>

        <span data-th-if="${currentPage < totalPages}">
        <a class="btn btn-outline-secondary btn-sm" data-th-href="@{|?boardNo=${board.boardNo}&page=${currentPage + 1}|}">
            [ë‹¤ìŒ]
        </a>
    </span>
        <span data-th-unless="${currentPage < totalPages}" class="btn btn-outline-secondary btn-sm disabled">[ë‹¤ìŒ]</span>
    </div>

</div>

<script>
    function enableEdit(button) {

        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');

        // í˜„ì¬ ë‚´ìš©ì„ ì €ì¥í•´ë‘ 
        textarea.setAttribute('data-original-content', textarea.value);

        // í…ìŠ¤íŠ¸ ì˜ì—­ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        textarea.removeAttribute('readonly');
        button.style.display = 'none'; // ìˆ˜ì • ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        // ì €ì¥ ë° ì·¨ì†Œ ë²„íŠ¼ì„ ì°¾ê³  í‘œì‹œ
        listItem.querySelector('button[onclick^="updateComment"]').style.display = 'inline'; // ì €ì¥ ë²„íŠ¼ í‘œì‹œ
        listItem.querySelector('button[onclick^="cancelEdit"]').style.display = 'inline'; // ì·¨ì†Œ ë²„íŠ¼ í‘œì‹œ
        listItem.querySelector('button[onclick^="deleteComment"]').style.display = 'none'; // ì‚­ì œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    }

    function updateComment(commentNo, boardNo, button) {
        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');
        const commentContent = textarea.value;

        if (confirm('ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            fetch(`../comment/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `commentNo=${commentNo}&commentContent=${encodeURIComponent(commentContent)}&boardType=1&boardNo=${boardNo}`
            }).then(response => {
                if (response.ok) {
                    alert('ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }y
            });
        }
    }

    function cancelEdit(button) {
        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');

        // ì €ì¥í•´ë‘” ì›ë˜ ë‚´ìš©ì„ ë˜ëŒë¦¬ê¸°
        textarea.value = textarea.getAttribute('data-original-content');
        textarea.setAttribute('readonly', true);

        // ë²„íŠ¼ í‘œì‹œ ìƒíƒœ ì›ë˜ëŒ€ë¡œ ë³µêµ¬
        listItem.querySelector('button[onclick="enableEdit(this)"]').style.display = 'inline'; // ìˆ˜ì • ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
        listItem.querySelector('button[onclick^="updateComment"]').style.display = 'none'; // ì €ì¥ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        listItem.querySelector('button[onclick^="cancelEdit"]').style.display = 'none'; // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        listItem.querySelector('button[onclick^="deleteComment"]').style.display = 'inline'; // ì‚­ì œ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œí•˜ê¸°
    }

    function deleteComment(commentNo, no) {
        if (confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            location.href = '../comment/delete?commentNo=' + commentNo + '&boardNo=' + no +'&boardType=1';
        }
    }
</script>
<script>

    function toggleCommentLike(commentNo) {
<!--    console.log(`Toggling like for commentNo: ${commentNo}`);--> ì½˜ì†” ë¡œê·¸
    fetch(`/comment/toggleCommentLike?commentNo=${commentNo}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
<!--        console.log(`Response data for commentNo ${commentNo}:`, data);--> ì½˜ì†” ë¡œê·¸

        const likeCountElem = document.getElementById(`commentLikeCount-${commentNo}`);
        const likeButtonElem = document.getElementById(`commentLikeButton-${commentNo}`);

        if (likeCountElem && likeButtonElem) {
            likeCountElem.value = data.commentLikeCount;
            likeButtonElem.textContent = data.isCommentLiked ? 'â¤ï¸ ì¢‹ì•„ìš” ì·¨ì†Œ' : 'ğŸ¤ ì¢‹ì•„ìš”';
            alert(data.message);
        } else {
            console.error(`Elements for commentNo ${commentNo} not found.`, {
                likeCountElem,
                likeButtonElem
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

</script>

<script>
    function changeCommentSort() {
        const sort = document.getElementById('commentSort').value;
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort', sort);
        urlParams.set('page', '1');  // í˜ì´ì§€ë¥¼ 1ë¡œ ì´ˆê¸°í™”
        window.location.search = urlParams.toString();
    }
</script>

<script>
    function adjustTextareaHeight(element) {
        // ê¸°ì¡´ ë†’ì´ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ ë†’ì´ ì¬ì¡°ì •
        element.style.height = 'auto';
        // ìŠ¤í¬ë¡¤ ë†’ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë†’ì´ë¥¼ ë‹¤ì‹œ ì„¤ì •
        element.style.height = (element.scrollHeight) + 'px';
    }

    // ëª¨ë“  textarea ìš”ì†Œì˜ ë†’ì´ë¥¼ í˜ì´ì§€ ë¡œë“œ ì‹œ ì¡°ì •
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('textarea').forEach(textarea => {
            adjustTextareaHeight(textarea);
        });
    });
</script>