<div class="container my-2" style="width: 1200px; margin: 0 auto;">
    <form data-th-action="@{/comment/add}" method="post" class="mb-3">
        <textarea name="commentContent" class="form-control mb-1"  rows="5" style="width: 100%; resize: none;" placeholder="댓글을 입력하세요"></textarea>
        <input type="hidden" name="boardType" value="1">
        <input type="hidden" name="boardNo" data-th-value="${board.boardNo}">
        <button type="submit" class="btn btn-secondary">댓글 등록</button>
    </form>

    <div class="mb-3">
        <select id="commentSort" class="form-select w-auto" onchange="changeCommentSort()">
            <option value="registered" data-th-selected="${sort == 'registered'}">등록순</option>
            <option value="likes" data-th-selected="${sort == 'likes'}">좋아요순</option>
        </select>
    </div>

    <p data-th-unless="${commentList}">댓글이 없습니다.</p>

    <ul class="list-unstyled" data-th-if="${commentList != null and commentList.size() > 0}">
        <li class="mb-1" data-th-each="comment : ${commentList}">
            <div class="p-3 border rounded shadow-sm bg-white"> <!-- 박스를 위한 스타일 -->
                <div class="d-flex align-items-center mb-2">
                    <img data-th-src="${board.writer.userPhoto != null ? board.writer.userPhoto : 'https://via.placeholder.com/60x60'}"
                         alt="User Photo" class="rounded-circle me-3" style="width: 60px; height: 60px;">
                    <strong class="me-2" data-th-text="${board.writer.userNickname}">닉네임</strong>
                    <small class="text-muted" data-th-text="${#calendars.format(comment.commentCreatedDate, 'yyyy년 MM월 dd일 HH:mm')}">작성일</small>
                </div>

                <textarea class="form-control mb-2" readonly rows="1" style="overflow: hidden; resize: none; border: none; background-color: transparent;"
                          data-th-text="${comment.commentContent}"
                          oninput="adjustTextareaHeight(this)">댓글 내용</textarea>

                <div class="d-flex align-items-center">
                    <button type="button"
                            class="btn btn-outline-danger btn-sm me-2"
                            data-th-id="'commentLikeButton-' + ${comment.commentNo}"
                            data-th-onclick="|toggleCommentLike(${comment.commentNo})|"
                            data-th-text="${commentLikedMap[comment.commentNo] != null && commentLikedMap[comment.commentNo] ? '❤️ 좋아요 취소' : '🤍 좋아요'}">
                    </button>
                    <span data-th-id="'commentLikeCount-' + ${comment.commentNo}" class="me-2" data-th-text="${comment.commentLike}">0</span>
                    <div data-th-if="${isLoggedIn and comment.userNo == loginUserNo}">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="enableEdit(this)">수정</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" data-th-onclick="|updateComment(${comment.commentNo}, ${board.boardNo}, this)|" style="display: none;">저장</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="cancelEdit(this)" style="display: none;">취소</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-th-onclick="|deleteComment(${comment.commentNo}, ${board.boardNo})|">삭제</button>
                    </div>
                </div>
            </div>
        </li>
    </ul>

    <div class="text-center">
    <span data-th-if="${currentPage > 1}">
        <a class="btn btn-outline-secondary btn-sm" data-th-href="@{|?boardNo=${board.boardNo}&page=${currentPage - 1}|}">
            [이전]
        </a>
    </span>
        <span data-th-unless="${currentPage > 1}" class="btn btn-outline-secondary btn-sm disabled">[이전]</span>

        <span data-th-each="i : ${#numbers.sequence(1, totalPages)}">
        <a class="btn btn-outline-secondary btn-sm"
           data-th-href="@{|?boardNo=${board.boardNo}&page=${i}|}"
           data-th-classappend="${i == currentPage} ? ' active' : ''"
           data-th-text="${i}">
           1
        </a>
    </span>

        <span data-th-if="${currentPage < totalPages}">
        <a class="btn btn-outline-secondary btn-sm" data-th-href="@{|?boardNo=${board.boardNo}&page=${currentPage + 1}|}">
            [다음]
        </a>
    </span>
        <span data-th-unless="${currentPage < totalPages}" class="btn btn-outline-secondary btn-sm disabled">[다음]</span>
    </div>

</div>

<script>
    function enableEdit(button) {

        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');

        // 현재 내용을 저장해둠
        textarea.setAttribute('data-original-content', textarea.value);

        // 텍스트 영역 수정 가능하게 설정
        textarea.removeAttribute('readonly');
        button.style.display = 'none'; // 수정 버튼 숨기기
        // 저장 및 취소 버튼을 찾고 표시
        listItem.querySelector('button[onclick^="updateComment"]').style.display = 'inline'; // 저장 버튼 표시
        listItem.querySelector('button[onclick^="cancelEdit"]').style.display = 'inline'; // 취소 버튼 표시
        listItem.querySelector('button[onclick^="deleteComment"]').style.display = 'none'; // 삭제 버튼 숨기기
    }

    function updateComment(commentNo, boardNo, button) {
        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');
        const commentContent = textarea.value;

        if (confirm('댓글을 수정하시겠습니까?')) {
            fetch(`../comment/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `commentNo=${commentNo}&commentContent=${encodeURIComponent(commentContent)}&boardType=1&boardNo=${boardNo}`
            }).then(response => {
                if (response.ok) {
                    alert('댓글이 수정되었습니다.');
                    location.reload(); // 페이지 새로고침
                } else {
                    alert('댓글 수정에 실패했습니다.');
                }y
            });
        }
    }

    function cancelEdit(button) {
        const listItem = button.closest('li');
        const textarea = listItem.querySelector('textarea');

        // 저장해둔 원래 내용을 되돌리기
        textarea.value = textarea.getAttribute('data-original-content');
        textarea.setAttribute('readonly', true);

        // 버튼 표시 상태 원래대로 복구
        listItem.querySelector('button[onclick="enableEdit(this)"]').style.display = 'inline'; // 수정 버튼 다시 표시
        listItem.querySelector('button[onclick^="updateComment"]').style.display = 'none'; // 저장 버튼 숨기기
        listItem.querySelector('button[onclick^="cancelEdit"]').style.display = 'none'; // 취소 버튼 숨기기
        listItem.querySelector('button[onclick^="deleteComment"]').style.display = 'inline'; // 삭제 버튼 다시 표시하기
    }

    function deleteComment(commentNo, no) {
        if (confirm('댓글을 삭제하시겠습니까?')) {
            location.href = '../comment/delete?commentNo=' + commentNo + '&boardNo=' + no +'&boardType=1';
        }
    }
</script>
<script>

    function toggleCommentLike(commentNo) {
<!--    console.log(`Toggling like for commentNo: ${commentNo}`);--> 콘솔 로그
    fetch(`/comment/toggleCommentLike?commentNo=${commentNo}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
<!--        console.log(`Response data for commentNo ${commentNo}:`, data);--> 콘솔 로그

        const likeCountElem = document.getElementById(`commentLikeCount-${commentNo}`);
        const likeButtonElem = document.getElementById(`commentLikeButton-${commentNo}`);

        if (likeCountElem && likeButtonElem) {
            likeCountElem.value = data.commentLikeCount;
            likeButtonElem.textContent = data.isCommentLiked ? '❤️ 좋아요 취소' : '🤍 좋아요';
            alert(data.message);
        } else {
            console.error(`Elements for commentNo ${commentNo} not found.`, {
                likeCountElem,
                likeButtonElem
            });
        }
    })
    .catch(error => console.error('Error:', error));
}

</script>

<script>
    function changeCommentSort() {
        const sort = document.getElementById('commentSort').value;
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort', sort);
        urlParams.set('page', '1');  // 페이지를 1로 초기화
        window.location.search = urlParams.toString();
    }
</script>

<script>
    function adjustTextareaHeight(element) {
        // 기존 높이를 초기화하여 높이 재조정
        element.style.height = 'auto';
        // 스크롤 높이를 기준으로 높이를 다시 설정
        element.style.height = (element.scrollHeight) + 'px';
    }

    // 모든 textarea 요소의 높이를 페이지 로드 시 조정
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('textarea').forEach(textarea => {
            adjustTextareaHeight(textarea);
        });
    });
</script>