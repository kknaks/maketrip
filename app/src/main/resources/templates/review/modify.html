<!DOCTYPE html>
<html>

<head data-th-replace="~{header :: head}"></head>
<header data-th-replace="~{header :: #page-header}"></header>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<body>
<div class="container mt-5">
    <h1 class="mb-4">게시글 수정</h1>

    <!-- 데이터 확인용 -->
    <div class="alert alert-info" role="alert" data-th-if="${trips.size() > 0}">
        디버깅용: Trip 데이터가 존재합니다.
    </div>
    <div class="alert alert-warning" role="alert" data-th-unless="${trips.size() > 0}">
        Trip 데이터가 없습니다.
    </div>

    <!-- 게시글이 없을 경우 -->
    <div class="alert alert-danger mt-4" data-th-unless="${board}">없는 게시글입니다.</div>

    <!-- 게시글이 있을 경우 -->
    <form id="update-form" data-th-if="${board}" data-th-action="@{update}" method="post" class="mt-4">
        <div class="mb-3">
            <label for="boardNo" class="form-label">게시글 번호</label>
            <input id="boardNo" name="boardNo" type="text" class="form-control" readonly th:value="${board.boardNo}">
        </div>

        <div class="mb-3">
            <label for="title" class="form-label">제목</label>
            <input id="title" name="title" type="text" class="form-control" th:value="${board.boardTitle}">
        </div>


        <!-- 여행 정보 -->
        <table class="table table-bordered">
            <thead class="table-light">
            <tr>
                <th>여행번호</th>
                <th>여행제목</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><span data-th-text="${board.trip.tripNo}">번호</span></td>
                <td><span data-th-text="${board.trip.tripTitle}">제목</span></td>
            </tr>
            </tbody>
        </table>

        <!-- 일정 리스트 -->
        <div id="scheduleContainer" class="mt-4">
            <h2 class="mb-4">일정 리스트</h2>
            <div id="scheduleList" class="list-group">
                <div class="list-group-item" data-th-each="schedule, status : ${schedule}" data-th-object="${schedule}">
                    <div class="d-flex align-items-start mb-3">
                        <span class="me-3 badge bg-secondary">일정번호: <span data-th-text="*{scheduleNo}">번호</span></span>
                        <span class="me-3">제목: <span data-th-text="*{location.locationName}">제목</span></span>
                        <span class="me-3">Day: <span data-th-text="*{scheduleDay}">Day</span></span>
                        <span class="me-3">순서: <span data-th-text="*{scheduleRoute}">순서</span></span>
                        <textarea name="scheduleContents" class="form-control" rows="3" placeholder="내용을 입력하세요"
                                  data-th-text="${#lists.size(board.boardContent.split('\n')) > status.index ? board.boardContent.split('\n')[status.index] : ''}">
                        </textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label for="boardTag" class="form-label">태그</label>
            <input id="boardTag" name="boardTag" type="text" class="form-control" data-th-value="${board.boardTag}">
        </div>

        <textarea name="content" id="boardContent" style="display:none;" th:text="${board.boardContent}"></textarea>
        <input type="hidden" name="tripNo" id="tripNo" th:value="${board.tripNo}">

        <!-- 기존 첨부 이미지 미리보기 -->
        <div id="existingImagesContainer" class="mb-3">
            <h5>기존 첨부 이미지</h5>
            <div data-th-each="image : ${board.boardImages}" class="d-inline-block position-relative m-2" data-image-id="[[${image.boardimageNo}]]">
                <img data-th-src="@{'https://dgg7dnk35523.edge.naverncp.com/HZiW9aEJy7/review/' + ${image.boardimageName} + '?type=u&w=100&h=100'}" class="img-thumbnail">
                <p class="text-center mt-1" data-th-text="${image.boardimageDefaultName}"></p>
                <!-- 이미지 ID를 사용하여 함수 호출 -->
                <button type="button" class="btn-close position-absolute top-0 start-80" onclick="removeExistingImage(this.closest('[data-image-id]').getAttribute('data-image-id'))"></button>
            </div>
        </div>

        <!-- 새 파일 첨부 버튼 -->
        <div class="mb-3">
            <label for="file-upload" class="form-label">파일 첨부</label>
            <input id="file-upload" name="imageFile" type="file" class="form-control" multiple onchange="previewImages()">
        </div>

        <!-- 미리보기 컨테이너 -->
        <div id="previewContainer" class="mb-3"></div>

        <input type="hidden" name="deletedImages" id="deletedImages">
        <button type="button" onclick="resetChanges()" class="btn btn-secondary me-2">취소</button>
        <button type="submit" class="btn btn-primary">변경</button>
    </form>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
    // 삭제된 이미지들을 저장할 Set
    let deletedImages = new Set();
    // 숨겨진 이미지들을 저장할 Map (취소를 위해)
    let hiddenImages = new Map();

    function removeExistingImage(imageId) {
        const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
        if (imageElement) {
            // 이미지 요소를 숨기고, 삭제할 목록에 추가
            imageElement.style.display = 'none';
            hiddenImages.set(imageId, imageElement);
            deletedImages.add(imageId); // Set에 이미지 ID 추가
            document.getElementById('deletedImages').value = Array.from(deletedImages).join(','); // 업데이트
        }
    }


    // 취소 버튼 처리
    function resetChanges() {
        // 숨겨진 이미지들 복원
        hiddenImages.forEach((element) => {
            element.style.display = 'inline-block';
        });

        // 상태 초기화
        deletedImages.clear();
        hiddenImages.clear();
        document.getElementById('deletedImages').value = '';

        // 새로 추가된 이미지 미리보기 초기화
        document.getElementById('previewContainer').innerHTML = '';
        document.getElementById('file-upload').value = '';

        // 이전 페이지로 돌아가기
        history.back();
    }

    // 폼 제출 전 처리
    document.getElementById('update-form').addEventListener('submit', function(event) {
        // 기존 scheduleContents 처리 유지
        const scheduleContents = Array.from(document.getElementsByName('scheduleContents')).map(textarea => textarea.value);
        document.getElementById('boardContent').value = scheduleContents.join('\n');

        // 삭제된 이미지 목록 최종 업데이트
        document.getElementById('deletedImages').value = Array.from(deletedImages).join(',');

        // 폼 제출 후 리다이렉트
        window.location.href = 'view?boardNo=' + document.getElementById('boardNo').value;
    });

    // 새 이미지 미리보기 기능
    function previewImages() {
        const previewContainer = document.getElementById('previewContainer');
        previewContainer.innerHTML = '';

        const files = document.getElementById('file-upload').files;
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewItem = document.createElement('div');
                previewItem.classList.add('d-inline-block', 'position-relative', 'm-2');

                previewItem.innerHTML = `
                <img src="${e.target.result}" class="img-thumbnail" style="width: 100px; height: 100px;">
                <p class="text-center mt-1">${file.name}</p>
                <button type="button" class="btn-close position-absolute top-0 start-80" onclick="removeImage(${index})"></button>
            `;
                previewContainer.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
    }

    function removeImage(index) {
        const fileInput = document.getElementById('file-upload');
        const dt = new DataTransfer();

        Array.from(fileInput.files).forEach((file, i) => {
            if (i !== index) dt.items.add(file);
        });

        fileInput.files = dt.files;
        previewImages();
    }
</script>
</body>
</html>